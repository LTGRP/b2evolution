var evo=evo||{};evo.shortcode={types:{image:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(image):(\d+):?([^\[\]]*)\])(<\/span>)?/g},thumbnail:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(thumbnail):(\d+):?([^\[\]]*)\])(<\/span>)?/g},inline:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(inline):(\d+):?([^\[\]]*)\])(<\/span>)?/g},button:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(button):image#(\d+)([^\[\]]*)\][^\[]*\[\/button\])(<\/span>)?/g},cta:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(cta):?\d*:image#(\d+)([^\[\]]*)\][^\[]*\[\/cta\])(<\/span>)?/g},like:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(like):image#(\d+)([^\[\]]*)\][^\[]*\[\/like\])(<\/span>)?/g},dislike:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(dislike):image#(\d+)([^\[\]]*)\][^\[]*\[\/dislike\])(<\/span>)?/g},activate:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(activate):image#(\d+)([^\[\]]*)\][^\[]*\[\/activate\])(<\/span>)?/g},unsubscribe:{regexp:/(<span.*?data-evo-tag.*?>)?(\[(unsubscribe):image#(\d+)([^\[\]]*)\][^\[]*\[\/unsubscribe\])(<\/span>)?/g}},next:function(a,b,c){var d,e=evo.shortcode.regexp(a);if(e.lastIndex=c||0,d=e.exec(b))return{index:d.index,content:d[0],shortcode:evo.shortcode.fromMatch(d)}},regexp:function(a){return evo.shortcode.types[a].regexp},fromMatch:function(a){return new evo.shortcode({type:a[3],link_ID:a[4],content:a[5]})}},evo.shortcode=$.extend(function(a){this.type=a.type,this.link_ID=a.link_ID,this.content=a.content},evo.shortcode),function(a,b,c,d){"use strict";var e={},f={};b.views={register:function(a,c){e[a]=b.View.extend(d.extend(c,{type:a}))},unregister:function(a){delete e[a]},get:function(a){return e[a]},unbind:function(){d.each(f,function(a,b){b.unbind()})},setMarkers:function(a){var b,c,f=[{content:a}],g=this;d.each(e,function(a,e){c=f.slice(),f=[],d.each(c,function(c,d){var h,i,j=d.content;if(d.processed)return void f.push(d);for(;j&&(h=e.prototype.match(j));)h.index&&f.push({content:j.substring(0,h.index)}),b=g.createInstance(a,h.content,h.options),i=b.loader?".":b.text,f.push({content:b.ignore?i:'<span data-evo-view-marker="'+b.encodedText+'">'+i+"</span>",processed:!0}),j=j.slice(h.index+h.content.length);j&&f.push({content:j})})});var h=[];return d.each(f,function(a,b){return h.push(b.content)}),a=h.join("")},createInstance:function(a,b,c,e){var g,h,i=this.get(a);return b=tinymce.DOM.decode(b),!e&&(h=this.getInstance(b))?h:(g=encodeURIComponent(b),c=d.extend(c||{},{text:b,encodedText:g,renderedHTML:null}),f[b]=new i(c))},getInstance:function(b){return"string"==typeof b?f[b]:f[a.decodeURIComponent(d(b).attr("data-evo-view-text"))]},getText:function(a){return decodeURIComponent(d(a).attr("data-evo-view-text")||"")},render:function(a){d.each(f,function(b,c){c.render(null,a)})},update:function(a,b,c,d){var e=this.getInstance(c);e&&e.update(a,b,c,d)},edit:function(a,b){var c=this.getInstance(b);c&&c.edit&&c.edit(c.text,function(d,e){c.update(d,a,b,e)})},remove:function(a,b){var c=this.getInstance(b);c&&c.remove(a,b)}},b.View=function(a){d.extend(this,a),this.initialize()},b.View.extend=function(a){var c=function(a){b.View.call(this,a)};c.prototype=Object.create(b.View.prototype),c.prototype.constructor=c;for(name in a)c.prototype[name]=a[name];return c},d.extend(b.View.prototype,{content:null,loader:!0,initialize:function(){},getContent:function(a){return this.content},render:function(a,b){var c=this;null!=a&&(this.content=a),a=this.getContent(),(this.loader||a)&&(b&&this.unbind(),this.replaceMarkers(),a&&this.setContent(a,function(a,b,e){d(b).data("rendered",!0),c.bindNode.call(c,a,b,e)},!!b&&null))},bindNode:function(){},unbindNode:function(){},unbind:function(){var a=this;this.getNodes(function(b,c,e){a.unbindNode.call(a,b,c,e),d(c).trigger("evo-view-unbind")},!0)},getEditors:function(a){d.each(tinymce.editors,function(b,c){c.plugins.evo_view&&a.call(this,c)},this)},getNodes:function(a,b){var c=this;this.getEditors(function(e){d(e.getBody()).find('[data-evo-view-text="'+c.encodedText+'"]').filter(function(){var a;return null==b||(a=!0===d(this).data("rendered"),b?a:!a)}).each(function(){a.call(c,e,this,d(this).find(".evo-view-content").get(0))})})},getMarkers:function(a){var b=this.encodedText;this.getEditors(function(c){var e=this;d(c.getBody()).find('[data-evo-view-marker="'+b+'"]').each(function(){a.call(e,c,this)})})},markerText:'<div class="evo-view-wrap" data-evo-view-text="%encodedText%" data-evo-view-type="%viewType%"><div class="evo-view-selection-before"></div><div class="evo-view-body" contenteditable="false"><div class="evo-view-content evo-view-type-%viewType%"></div></div><div class="evo-view-selection-after"></div></div>',replaceMarkers:function(){var a=this;this.getMarkers(function(b,c){var e,f=c===b.selection.getNode();if(!a.loader&&d(c).text()!==a.text)return void b.dom.setAttrib(c,"data-evo-view-marker",null);var g=a.markerText.replace(/%encodedText%/g,a.encodedText).replace(/%viewType%/g,a.type);e=b.$(g),b.$(c).replaceWith(e),f&&b.evo.setViewCursor(!1,e[0])})},removeMarkers:function(){this.getMarkers(function(a,b){a.dom.setAttrib(b,"data-evo-view-marker",null)})},setContent:function(a,b,c){"object"===d.type(a)&&-1!==a.body.indexOf("<script")?this.setIframes(a.head||"",a.body,b,c):"string"===d.type(a)&&-1!==a.indexOf("<script")?this.setIframes("",a,b,c):a==this.text?this.getNodes(function(a,b,c){b.replaceWith(this.text)},c):this.getNodes(function(c,d,e){a=a.body||a,-1!==a.indexOf("<iframe")&&(a+='<div class="evo-view-overlay"></div>'),e.innerHTML="",e.appendChild("string"==typeof a?c.dom.createFragment(a):a),b&&b.call(this,c,d,e)},c)},setIframes:function(b,c,e,f){var g=a.MutationObserver||a.WebKitMutationObserver||a.MozMutationObserver,h=this;this.getNodes(function(a,f,i){var j=a.dom,k="",l=a.getBody().className||"",m=a.getDoc().getElementsByTagName("head")[0];tinymce.each(j.$('link[rel="stylesheet"]',m),function(a,b){b.href&&-1===b.href.indexOf("skins/lightgray/content.min.css")&&-1===b.href.indexOf("skins/wordpress/wp-content.css")&&(k+=j.getOuterHTML(b))}),h.iframeHeight&&j.add(i,"div",{style:{width:"100%",height:h.iframeHeight}}),setTimeout(function(){function m(){var b;s||o.contentWindow&&(b=d(o),h.iframeHeight=d(p.body).height(),b.height()!==h.iframeHeight&&(b.height(h.iframeHeight),a.nodeChanged()))}function n(){p.body.className=a.getBody().className}var o,p,q,r,s;if(i.innerHTML="",o=j.add(i,"iframe",{src:tinymce.Env.ie?'javascript:""':"",frameBorder:"0",allowTransparency:"true",scrolling:"no",class:"evo-view-sandbox",style:{width:"100%",display:"block"},height:h.iframeHeight}),j.add(i,"div",{class:"evo-view-overlay"}),p=o.contentWindow.document,p.open(),p.write('<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+b+k+'<style>html {background: transparent;padding: 0;margin: 0;}body#evo-view-iframe-sandbox {background: transparent;padding: 1px 0 !important;margin: -1px 0 0 !important;}body#evo-view-iframe-sandbox:before,body#evo-view-iframe-sandbox:after {display: none;content: "";}</style></head><body id="evo-view-iframe-sandbox" class="'+l+'">'+c+"</body></html>"),p.close(),h.iframeHeight&&(s=!0,setTimeout(function(){s=!1,m()},3e3)),d(o.contentWindow).on("load",m),g)q=new g(_.debounce(m,100)),q.observe(p.body,{attributes:!0,childList:!0,subtree:!0}),d(f).one("evo-view-unbind",function(){q.disconnect()});else for(r=1;r<6;r++)setTimeout(m,700*r);a.on("evo-body-class-change",n),d(f).one("evo-view-unbind",function(){a.off("evo-body-class-change",n)}),e&&e.call(h,a,f,i)},50)},f)},setLoader:function(){this.setContent('<div class="loading-placeholder"><div class="dashicons dashicons-admin-media"></div><div class="evo-view-loading"><ins></ins></div></div>')},setError:function(a,b){this.setContent('<div class="evo-view-error"><div class="dashicons dashicons-'+(b||"no")+'"></div><p>'+a+"</p></div>")},match:function(a){var b=c.next(this.type,a);if(b)return{index:b.index,content:b.content,options:{shortcode:b.shortcode}}},update:function(a,b,c,f){d.each(e,function(g,h){var i=h.prototype.match(a);if(i)return d(c).data("rendered",!1),b.dom.setAttrib(c,"data-evo-view-text",encodeURIComponent(a)),e.createInstance(type,a,i.options,f).render(),b.focus(),!1})},remove:function(a,b){this.unbindNode.call(this,a,b,d(b).find(".evo-view-content").get(0)),d(b).trigger("evo-view-unbind"),a.dom.remove(b),a.focus()}})}(window,window.evo,window.evo.shortcode,window.jQuery),function(a,b,c){var d,e;d={loader:!0},e=c.extend({},d,{initialize:function(){var a=this,b=[];b.push("tags[]="+encodeURI(a.text)),b.length&&(b=b.join("&")),this.getEditors(function(c){tinymce.util.XHR.send({url:c.getParam("anon_async_url")+"?action=render_inlines&type="+c.getParam("target_type")+"&id="+(void 0==c.getParam("target_ID")?"":c.getParam("target_ID"))+(c.getParam("temp_ID")?"&temp_link_owner_ID="+c.getParam("temp_ID"):""),content_type:"application/x-www-form-urlencoded",data:b,success:function(b){var d=tinymce.util.JSON.parse(b),e=c.dom.create("div"),f=c.dom.createFragment(d[a.text]);e.appendChild(f),a.render(e.innerHTML)}})})}}),b.register("image",e);var f=c.extend({},e,{markerText:'<span class="evo-view-wrap" data-evo-view-text="%encodedText%" data-evo-view-type="%viewType%"><span class="evo-view-selection-before"> </span><span class="evo-view-body" contenteditable="false"><span class="evo-view-content evo-view-type-%viewType%"></span></span><span class="evo-view-selection-after"> </span></span>'});b.register("thumbnail",f),b.register("inline",f);var g=c.extend({},e,{markerText:'<div class="evo-view-wrap" data-evo-view-text="%encodedText%" data-evo-view-type="%viewType%" data-evo-view-plugin-type="email_element"><div class="evo-view-selection-before"></div><div class="evo-view-body" contenteditable="false"><div class="evo-view-content evo-view-type-%viewType%"></div></div><div class="evo-view-selection-after"></div></div>'});b.register("button",g),b.register("cta",g),b.register("like",g),b.register("dislike",g),b.register("activate",g),b.register("unsubscribe",g)}(window,window.evo.views,window.jQuery);