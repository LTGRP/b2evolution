tinymce.PluginManager.add("image",function(b){function v(e,n,t){return function i(e,a){return a=a||[],tinymce.each(e,function(e){var t={text:e.text||e.title};e.menu?t.menu=i(e.menu):(t.value=e.value,n(t)),a.push(t)}),a}(e,t||[])}function e(t){return function(){var e=b.settings.image_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(e){t(tinymce.util.JSON.parse(e))}}):"function"==typeof e?e(t):t(e)}}function t(e){var r,l,t,o,s,g,i,c={},m=b.dom,d=!1!==b.settings.image_dimensions;function u(){var e,t,i,a;e=r.find("#width")[0],t=r.find("#height")[0],e&&t&&(i=e.value(),a=t.value(),r.find("#constrain")[0].checked()&&o&&s&&i&&a&&(o!=i?(a=Math.round(i/o*a),isNaN(a)||t.value(a)):(i=Math.round(a/s*i),isNaN(i)||e.value(i))),o=i,s=a)}function a(){var a,n;f(),u(),(c=tinymce.extend(c,r.toJSON())).alt||(c.alt=""),c.title||(c.title=""),""===c.width&&(c.width=null),""===c.height&&(c.height=null),c.style||(c.style=null),c={src:c.src,alt:c.alt,title:c.title,width:c.width,height:c.height,style:c.style,caption:c.caption,class:c.class},b.undoManager.transact(function(){var e;if(c.src){if(""===c.title&&(c.title=null),l?m.setAttribs(l,c):(c.id="__mcenew",b.focus(),b.selection.setContent(m.createHTML("img",c)),l=m.get("__mcenew"),m.setAttrib(l,"id",null)),b.editorUpload.uploadImagesAuto(),!1===c.caption&&m.is(l.parentNode,"figure.image")&&(a=l.parentNode,m.insertAfter(l,a),m.remove(a)),!0!==c.caption)(e=l).onload=function(){c.width||c.height||!d||m.setAttribs(e,{width:e.clientWidth,height:e.clientHeight}),i()},e.onerror=i;else if(!m.is(l.parentNode,"figure.image")){l=(n=l).cloneNode(!0),(a=m.create("figure",{class:"image"})).appendChild(l),a.appendChild(m.create("figcaption",{contentEditable:!0},"Caption")),a.contentEditable=!1;var t=m.getParent(n,function(e){return b.schema.getTextBlockElements()[e.nodeName]});t?m.split(t,n,a):m.replace(a,n),b.selection.select(a)}}else l&&(m.remove(l),b.focus(),b.nodeChanged());function i(){e.onload=e.onerror=null,b.selection&&(b.selection.select(e),b.nodeChanged())}})}function n(e){return e=e&&e.replace(/px$/,"")}l=b.selection.getNode(),(t=m.getParent(l,"figure.image"))&&(l=m.select("img",t)[0]),l&&("IMG"!=l.nodeName||l.getAttribute("data-mce-object")||l.getAttribute("data-mce-placeholder"))&&(l=null),l&&(o=m.getAttrib(l,"width"),s=m.getAttrib(l,"height"),c={src:m.getAttrib(l,"src"),alt:m.getAttrib(l,"alt"),title:m.getAttrib(l,"title"),class:m.getAttrib(l,"class"),width:o,height:s,caption:!!t}),e&&(g={type:"listbox",label:"Image list",values:v(e,function(e){e.value=b.convertURL(e.value||e.url,"src")},[{text:"None",value:""}]),value:c.src&&b.convertURL(c.src,"src"),onselect:function(e){var t=r.find("#alt");(!t.value()||e.lastControl&&t.value()==e.lastControl.text())&&t.value(e.control.text()),r.find("#src").value(e.control.value()).fire("change")},onPostRender:function(){g=this}}),b.settings.image_class_list&&(i={name:"class",type:"listbox",label:"Class",values:v(b.settings.image_class_list,function(e){e.value&&(e.textStyle=function(){return b.formatter.getCssText({inline:"img",classes:[e.value]})})})});var h=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:function(e){var t,i,a,n=e.meta||{};g&&g.value(b.convertURL(this.value(),"src")),tinymce.each(n,function(e,t){r.find("#"+t).value(e)}),n.width||n.height||(t=b.convertURL(this.value(),"src"),i=b.settings.image_prepend_url,a=new RegExp("^(?:[a-z]+:)?//","i"),i&&!a.test(t)&&t.substring(0,i.length)!==i&&(t=i+t),this.value(t),function(e,i){var a=document.createElement("img");function t(e,t){a.parentNode&&a.parentNode.removeChild(a),i({width:e,height:t})}a.onload=function(){t(Math.max(a.width,a.clientWidth),Math.max(a.height,a.clientHeight))},a.onerror=function(){t()};var n=a.style;n.visibility="hidden",n.position="fixed",n.bottom=n.left=0,n.width=n.height="auto",document.body.appendChild(a),a.src=e}(b.documentBaseURI.toAbsolute(this.value()),function(e){e.width&&e.height&&d&&(o=e.width,s=e.height,r.find("#width").value(o),r.find("#height").value(s))}))}},g];function p(e){if(e.margin){var t=e.margin.split(" ");switch(t.length){case 1:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[0],e["margin-bottom"]=e["margin-bottom"]||t[0],e["margin-left"]=e["margin-left"]||t[0];break;case 2:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[0],e["margin-left"]=e["margin-left"]||t[1];break;case 3:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[2],e["margin-left"]=e["margin-left"]||t[1];break;case 4:e["margin-top"]=e["margin-top"]||t[0],e["margin-right"]=e["margin-right"]||t[1],e["margin-bottom"]=e["margin-bottom"]||t[2],e["margin-left"]=e["margin-left"]||t[3]}delete e.margin}return e}function f(){function e(e){return 0<e.length&&/^[0-9]+$/.test(e)&&(e+="px"),e}if(b.settings.image_advtab){var t=r.toJSON(),i=m.parseStyle(t.style);i=p(i),t.vspace&&(i["margin-top"]=i["margin-bottom"]=e(t.vspace)),t.hspace&&(i["margin-left"]=i["margin-right"]=e(t.hspace)),t.border&&(i["border-width"]=e(t.border)),r.find("#style").value(m.serializeStyle(m.parseStyle(m.serializeStyle(i))))}}!1!==b.settings.image_description&&h.push({name:"alt",type:"textbox",label:"Image description"}),b.settings.image_title&&h.push({name:"title",type:"textbox",label:"Image Title"}),d&&h.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:u,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:u,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),h.push(i),b.settings.image_caption&&tinymce.Env.ceFalse&&h.push({name:"caption",type:"checkbox",label:"Caption"}),r=b.settings.image_advtab?(l&&(l.style.marginLeft&&l.style.marginRight&&l.style.marginLeft===l.style.marginRight&&(c.hspace=n(l.style.marginLeft)),l.style.marginTop&&l.style.marginBottom&&l.style.marginTop===l.style.marginBottom&&(c.vspace=n(l.style.marginTop)),l.style.borderWidth&&(c.border=n(l.style.borderWidth)),c.style=b.dom.serializeStyle(b.dom.parseStyle(b.dom.getAttrib(l,"style")))),b.windowManager.open({title:"Insert/edit image",data:c,bodyType:"tabpanel",body:[{title:"General",type:"form",items:h},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:function(){if(b.settings.image_advtab){var e=r.toJSON(),t=m.parseStyle(e.style);r.find("#vspace").value(""),r.find("#hspace").value(""),((t=p(t))["margin-top"]&&t["margin-bottom"]||t["margin-right"]&&t["margin-left"])&&(t["margin-top"]===t["margin-bottom"]?r.find("#vspace").value(n(t["margin-top"])):r.find("#vspace").value(""),t["margin-right"]===t["margin-left"]?r.find("#hspace").value(n(t["margin-right"])):r.find("#hspace").value("")),t["border-width"]&&r.find("#border").value(n(t["border-width"])),r.find("#style").value(m.serializeStyle(m.parseStyle(m.serializeStyle(t))))}}},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:f},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:a})):b.windowManager.open({title:"Insert/edit image",data:c,body:h,onSubmit:a})}b.on("preInit",function(){function e(r){return function(e){var t,i,a=e.length;function n(e){e.attr("contenteditable",r?"true":null)}for(;a--;)t=e[a],(i=t.attr("class"))&&/\bimage\b/.test(i)&&(t.attr("contenteditable",r?"false":null),tinymce.each(t.getAll("figcaption"),n))}}b.parser.addNodeFilter("figure",e(!0)),b.serializer.addNodeFilter("figure",e(!1))}),b.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:e(t),onPostRender:function(){var a=this,n=b.plugins.b2evo_shorttags;n?b.on("NodeChange",function(e){var t=b.selection.getNode(),i=n.selected();i?a.disabled(!0):a.disabled(!1),a.active(!i&&b.dom.is(t,"img:not([data-mce-object],[data-mce-placeholder]),figure.image"))}):this.stateSelector="img:not([data-mce-object],[data-mce-placeholder]),figure.image"}}),b.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:e(t),context:"insert",prependToContext:!0}),b.addCommand("mceImage",e(t))});